# PARTSCONTROL 项目部署指南

## 🎯 部署前准备

### 1. 服务器环境要求

#### 最低配置要求
- **CPU**: 2核心
- **内存**: 4GB RAM
- **存储**: 20GB 可用空间
- **操作系统**: Ubuntu 20.04+ / CentOS 7+ / Debian 10+

#### 必需软件
- **Node.js**: 16.x 或更高版本
- **npm**: 8.x 或更高版本
- **MySQL**: 8.0 或 PostgreSQL 12+
- **Nginx**: 用于反向代理
- **Git**: 用于代码拉取

### 2. 域名和SSL证书
- 准备一个域名（如：partcontrol.yourdomain.com）
- 申请SSL证书（推荐使用Let's Encrypt免费证书）

## 📋 部署步骤

### 第一步：服务器环境准备

#### 1.1 连接服务器
```bash
# 使用SSH连接您的服务器
ssh root@your-server-ip
```

#### 1.2 更新系统
```bash
# Ubuntu/Debian
sudo apt update && sudo apt upgrade -y

# CentOS/RHEL
sudo yum update -y
```

#### 1.3 安装Node.js
```bash
# 方法1：使用NodeSource仓库（推荐）
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt-get install -y nodejs

# 验证安装
node --version
npm --version
```

#### 1.4 安装MySQL
```bash
# Ubuntu/Debian
sudo apt install mysql-server -y

# 启动MySQL服务
sudo systemctl start mysql
sudo systemctl enable mysql

# 安全配置
sudo mysql_secure_installation
```

#### 1.5 安装Nginx
```bash
sudo apt install nginx -y
sudo systemctl start nginx
sudo systemctl enable nginx
```

#### 1.6 安装Git
```bash
sudo apt install git -y
```

### 第二步：项目部署

#### 2.1 创建项目目录
```bash
# 创建项目目录
sudo mkdir -p /var/www/partcontrol
sudo chown $USER:$USER /var/www/partcontrol
cd /var/www/partcontrol
```

#### 2.2 上传项目文件
```bash
# 方法1：使用Git（推荐）
git clone https://github.com/your-username/PARTSCONTROL.git .

# 方法2：使用SCP上传
# 在本地执行：
scp -r /path/to/PARTSCONTROL root@your-server-ip:/var/www/partcontrol/
```

#### 2.3 配置环境变量
```bash
# 复制环境变量模板
cp env.example .env

# 编辑环境变量
nano .env
```

#### 2.4 配置数据库
```bash
# 登录MySQL
sudo mysql -u root -p

# 创建数据库和用户
CREATE DATABASE partcontrol CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
CREATE USER 'partcontrol'@'localhost' IDENTIFIED BY 'your-strong-password';
GRANT ALL PRIVILEGES ON partcontrol.* TO 'partcontrol'@'localhost';
FLUSH PRIVILEGES;
EXIT;
```

### 第三步：后端部署

#### 3.1 安装后端依赖
```bash
cd /var/www/partcontrol/后端
npm install
```

#### 3.2 配置后端环境变量
```bash
# 编辑后端环境变量
nano .env
```

配置内容示例：
```env
# 数据库配置
DB_HOST=localhost
DB_PORT=3306
DB_NAME=partcontrol
DB_USER=partcontrol
DB_PASSWORD=your-strong-password

# JWT配置
JWT_SECRET=your-super-secret-jwt-key
JWT_EXPIRES_IN=24h

# 服务器配置
PORT=3000
NODE_ENV=production

# 邮件配置
MAIL_HOST=smtp.gmail.com
MAIL_PORT=587
MAIL_USER=your-email@gmail.com
MAIL_PASS=your-app-password

# 文件上传配置
UPLOAD_PATH=./uploads
MAX_FILE_SIZE=10485760
```

#### 3.3 创建必要目录
```bash
# 创建上传目录
mkdir -p uploads
mkdir -p logs

# 设置权限
chmod 755 uploads
chmod 755 logs
```

#### 3.4 启动后端服务
```bash
# 开发模式测试
npm start

# 生产模式（使用PM2）
npm install -g pm2
pm2 start server.js --name "partcontrol-backend"
pm2 save
pm2 startup
```

### 第四步：前端部署

#### 4.1 安装前端依赖
```bash
cd /var/www/partcontrol/前端
npm install
```

#### 4.2 配置前端环境变量
```bash
# 创建生产环境配置
nano .env.production
```

配置内容：
```env
VITE_API_BASE_URL=https://your-domain.com/api
VITE_APP_TITLE=PARTSCONTROL
```

#### 4.3 构建前端
```bash
# 构建生产版本
npm run build

# 构建完成后，dist目录包含静态文件
```

#### 4.4 配置Nginx
```bash
# 创建Nginx配置文件
sudo nano /etc/nginx/sites-available/partcontrol
```

配置内容：
```nginx
server {
    listen 80;
    server_name your-domain.com;
    
    # 前端静态文件
    location / {
        root /var/www/partcontrol/前端/dist;
        try_files $uri $uri/ /index.html;
        index index.html;
    }
    
    # 后端API代理
    location /api {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }
    
    # 文件上传目录
    location /uploads {
        alias /var/www/partcontrol/后端/uploads;
        expires 30d;
        add_header Cache-Control "public, immutable";
    }
}
```

#### 4.5 启用Nginx配置
```bash
# 创建软链接
sudo ln -s /etc/nginx/sites-available/partcontrol /etc/nginx/sites-enabled/

# 测试配置
sudo nginx -t

# 重启Nginx
sudo systemctl restart nginx
```

### 第五步：SSL证书配置

#### 5.1 安装Certbot
```bash
# Ubuntu/Debian
sudo apt install certbot python3-certbot-nginx -y
```

#### 5.2 申请SSL证书
```bash
sudo certbot --nginx -d your-domain.com
```

#### 5.3 自动续期
```bash
# 测试自动续期
sudo certbot renew --dry-run

# 添加到crontab
sudo crontab -e
# 添加以下行：
0 12 * * * /usr/bin/certbot renew --quiet
```

### 第六步：防火墙配置

#### 6.1 配置UFW防火墙
```bash
# 安装UFW
sudo apt install ufw -y

# 设置默认策略
sudo ufw default deny incoming
sudo ufw default allow outgoing

# 允许SSH
sudo ufw allow ssh

# 允许HTTP和HTTPS
sudo ufw allow 80
sudo ufw allow 443

# 启用防火墙
sudo ufw enable
```

### 第七步：监控和日志

#### 7.1 配置日志轮转
```bash
# 创建日志轮转配置
sudo nano /etc/logrotate.d/partcontrol
```

配置内容：
```
/var/www/partcontrol/后端/logs/*.log {
    daily
    missingok
    rotate 30
    compress
    delaycompress
    notifempty
    create 644 www-data www-data
    postrotate
        systemctl reload nginx
    endscript
}
```

#### 7.2 设置监控
```bash
# 安装htop监控工具
sudo apt install htop -y

# 查看系统资源
htop
```

## 🔧 常见问题解决

### 1. 端口被占用
```bash
# 查看端口占用
sudo netstat -tlnp | grep :3000

# 杀死进程
sudo kill -9 <PID>
```

### 2. 权限问题
```bash
# 修复文件权限
sudo chown -R www-data:www-data /var/www/partcontrol
sudo chmod -R 755 /var/www/partcontrol
```

### 3. 数据库连接失败
```bash
# 检查MySQL状态
sudo systemctl status mysql

# 重启MySQL
sudo systemctl restart mysql
```

### 4. Nginx配置错误
```bash
# 检查Nginx配置
sudo nginx -t

# 查看Nginx错误日志
sudo tail -f /var/log/nginx/error.log
```

## 📊 部署验证

### 1. 检查服务状态
```bash
# 检查后端服务
pm2 status

# 检查Nginx服务
sudo systemctl status nginx

# 检查MySQL服务
sudo systemctl status mysql
```

### 2. 测试API接口
```bash
# 测试健康检查接口
curl http://localhost:3000/api/health

# 测试前端访问
curl -I http://your-domain.com
```

### 3. 检查SSL证书
```bash
# 检查SSL证书状态
sudo certbot certificates
```

## 🚀 自动化部署脚本

### 使用提供的部署脚本
```bash
# 给脚本执行权限
chmod +x deploy.sh

# 运行部署脚本
./deploy.sh
```

## 📞 技术支持

如果遇到问题，请检查：
1. 服务器日志：`/var/log/nginx/error.log`
2. 应用日志：`/var/www/partcontrol/后端/logs/`
3. PM2日志：`pm2 logs`

## 🔒 安全建议

1. **定期更新系统**：`sudo apt update && sudo apt upgrade`
2. **备份数据库**：设置自动备份脚本
3. **监控资源**：使用htop或类似工具
4. **日志监控**：定期检查错误日志
5. **SSL证书**：确保证书自动续期

---

**部署完成时间**: 根据服务器配置，通常需要30-60分钟  
**建议**: 首次部署建议在测试环境进行 